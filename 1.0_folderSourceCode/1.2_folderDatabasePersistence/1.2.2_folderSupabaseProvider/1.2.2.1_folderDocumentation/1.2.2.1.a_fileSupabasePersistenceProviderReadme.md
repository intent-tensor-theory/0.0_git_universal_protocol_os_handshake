# Supabase Persistence Provider

**Address:** `1.2.2`  
**Type:** Supabase PostgreSQL  
**Setup Required:** Supabase account + schema creation

---

## Overview

Supabase provider uses a cloud-hosted PostgreSQL database with real-time capabilities. Perfect for production multi-user deployments.

## Features

| Feature | Supported |
|---------|-----------|
| Cloud Hosted | ✅ |
| Multi-User | ✅ |
| Real-Time Sync | ✅ |
| Row-Level Security | ✅ |
| Transactions | ✅ (simulated) |
| Offline Support | ❌ |
| Free Tier | ✅ |

## Setup

### 1. Create Supabase Project

1. Go to [supabase.com](https://supabase.com) and create account
2. Create a new project
3. Wait for database provisioning (~2 minutes)

### 2. Create Database Schema

In your Supabase dashboard:
1. Go to **SQL Editor**
2. Copy the schema from `1.2.2.b_fileSupabaseClientConfiguration.ts`
3. Run the SQL

Or run via CLI:
```bash
supabase db push
```

### 3. Get API Credentials

From your Supabase dashboard:
1. Go to **Settings → API**
2. Copy:
   - **Project URL** (e.g., `https://xxx.supabase.co`)
   - **anon public** key

### 4. Configure Environment

```env
# .env
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Optional
VITE_SUPABASE_SCHEMA=public
VITE_DB_DEBUG=true
```

### 5. Switch Provider

```typescript
// In 1.2.c_fileActiveDatabaseProviderToggle.ts
const ACTIVE_PROVIDER: DatabaseProviderType = 'supabase';
```

## Database Schema

```sql
platforms
├── id (UUID, PK)
├── serial (VARCHAR)
├── name (VARCHAR)
├── url (VARCHAR)
├── contributors (JSONB)
├── is_master (BOOLEAN)
├── is_archived (BOOLEAN)
├── created_at (TIMESTAMPTZ)
└── updated_at (TIMESTAMPTZ)

resources
├── id (UUID, PK)
├── serial (VARCHAR)
├── platform_id (UUID, FK → platforms)
├── title (VARCHAR)
├── description (TEXT)
├── is_archived (BOOLEAN)
├── created_at (TIMESTAMPTZ)
└── updated_at (TIMESTAMPTZ)

handshakes
├── id (UUID, PK)
├── serial (VARCHAR)
├── resource_id (UUID, FK → resources)
├── title (VARCHAR)
├── protocol_type (VARCHAR)
├── authentication (JSONB)
├── status (VARCHAR)
├── created_at (TIMESTAMPTZ)
└── updated_at (TIMESTAMPTZ)
```

## Row-Level Security (RLS)

For multi-tenant deployments, enable RLS:

```sql
-- Enable RLS
ALTER TABLE platforms ENABLE ROW LEVEL SECURITY;

-- Example policy: Users can only see their own platforms
CREATE POLICY "Users can view own platforms"
  ON platforms FOR SELECT
  USING (auth.uid() = user_id);

-- Example policy: Users can only modify their own platforms
CREATE POLICY "Users can modify own platforms"
  ON platforms FOR ALL
  USING (auth.uid() = user_id);
```

## Real-Time Subscriptions

Subscribe to changes:

```typescript
import { getActiveProvider } from '@database';

const supabase = (getActiveProvider() as SupabasePersistenceProvider).client;

const subscription = supabase
  .channel('platforms')
  .on('postgres_changes', 
    { event: '*', schema: 'public', table: 'platforms' },
    (payload) => {
      console.log('Change received:', payload);
    }
  )
  .subscribe();
```

## Pricing

| Tier | Cost | Limits |
|------|------|--------|
| Free | $0/mo | 500MB database, 1GB file storage |
| Pro | $25/mo | 8GB database, 100GB file storage |
| Team | $599/mo | Unlimited |

## Troubleshooting

### "relation does not exist"

Schema not created. Run the SQL from `1.2.2.b_fileSupabaseClientConfiguration.ts`.

### "JWT expired"

Token needs refresh. Check `autoRefreshToken` is enabled.

### "permission denied"

RLS is blocking access. Check policies or disable RLS for testing.

### "connection refused"

- Check URL is correct
- Verify project is active (not paused)
- Check firewall/network

## Migrating Data

### From localStorage to Supabase

```typescript
// Export from localStorage
const localDb = new LocalStoragePersistenceProvider();
await localDb.initialize({ type: 'localStorage' });
const { data } = await localDb.exportAllData();

// Import to Supabase
await setActiveProvider('supabase');
const supabaseDb = getActiveProvider();
await supabaseDb.importData(data);
```

### Backup to JSON

```typescript
const db = getActiveProvider();
const { data } = await db.exportAllData();

// Download as file
const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
const url = URL.createObjectURL(blob);
```

---

## When to Use

✅ **Recommended for:**
- Production deployments
- Multi-user applications
- Real-time collaboration
- Teams needing auth integration

❌ **Not recommended for:**
- Offline-first requirements
- Edge/serverless with cold starts
- Extremely latency-sensitive apps
