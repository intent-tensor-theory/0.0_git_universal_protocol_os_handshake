# PostgreSQL Persistence Provider

**Address:** `1.2.4`  
**Type:** Direct PostgreSQL  
**Setup Required:** PostgreSQL server + schema creation

---

## Overview

PostgreSQL provider connects directly to a PostgreSQL database, offering full SQL power and ACID transactions. Best for server-side deployments or existing PostgreSQL infrastructure.

## Features

| Feature | Supported |
|---------|-----------|
| Full SQL | ✅ |
| ACID Transactions | ✅ |
| Connection Pooling | ✅ |
| Stored Procedures | ✅ |
| Complex Queries | ✅ |
| Self-Hosted | ✅ |
| Browser Direct | ❌ |

## Important Note

PostgreSQL requires TCP socket connections which **cannot run directly in the browser**. You need one of:

1. **Server-side rendering (SSR)** - Node.js backend
2. **API proxy** - REST/GraphQL layer
3. **Edge functions** - Serverless PostgreSQL (Neon, PlanetScale)
4. **Supabase** - Use the Supabase provider instead (built on PostgreSQL)

## Setup

### 1. Install PostgreSQL

**macOS:**
```bash
brew install postgresql@15
brew services start postgresql@15
```

**Ubuntu/Debian:**
```bash
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
```

**Docker:**
```bash
docker run -d \
  --name protocol-os-db \
  -e POSTGRES_PASSWORD=mypassword \
  -e POSTGRES_DB=protocol_os \
  -p 5432:5432 \
  postgres:15
```

### 2. Create Database

```bash
createdb protocol_os
# Or via psql:
psql -c "CREATE DATABASE protocol_os;"
```

### 3. Run Schema Migration

Execute the SQL from `1.2.4.b_filePostgresqlClientConfiguration.ts`:

```bash
psql -d protocol_os -f schema.sql
```

Or programmatically:
```typescript
import { POSTGRESQL_SCHEMA_SQL } from './1.2.4.b_filePostgresqlClientConfiguration';
await pool.query(POSTGRESQL_SCHEMA_SQL);
```

### 4. Configure Environment

```env
# .env
VITE_POSTGRESQL_URL=postgresql://user:password@localhost:5432/protocol_os

# Optional
VITE_POSTGRESQL_SSL=false
VITE_POSTGRESQL_POOL_MIN=2
VITE_POSTGRESQL_POOL_MAX=10
VITE_DB_DEBUG=true
```

### 5. Switch Provider

```typescript
// In 1.2.c_fileActiveDatabaseProviderToggle.ts
const ACTIVE_PROVIDER: DatabaseProviderType = 'postgresql';
```

## Database Schema

```
┌─────────────────────────────────────────────────────────────┐
│                        platforms                             │
├─────────────────────────────────────────────────────────────┤
│ id            UUID PRIMARY KEY                               │
│ serial        VARCHAR(50) UNIQUE                            │
│ name          VARCHAR(255)                                  │
│ url           VARCHAR(500)                                  │
│ contributors  JSONB                                         │
│ is_master     BOOLEAN                                       │
│ is_archived   BOOLEAN                                       │
│ created_at    TIMESTAMPTZ                                   │
│ updated_at    TIMESTAMPTZ                                   │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ 1:N
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                        resources                             │
├─────────────────────────────────────────────────────────────┤
│ id            UUID PRIMARY KEY                               │
│ platform_id   UUID REFERENCES platforms(id) ON DELETE CASCADE│
│ serial        VARCHAR(50)                                   │
│ title         VARCHAR(255)                                  │
│ description   TEXT                                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ 1:N
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                        handshakes                            │
├─────────────────────────────────────────────────────────────┤
│ id            UUID PRIMARY KEY                               │
│ resource_id   UUID REFERENCES resources(id) ON DELETE CASCADE│
│ protocol_type VARCHAR(50)                                   │
│ authentication JSONB                                        │
│ status        VARCHAR(20)                                   │
└─────────────────────────────────────────────────────────────┘
```

## Connection Pooling

The provider uses `pg` connection pooling:

```typescript
const pool = createPostgresqlPool(connectionString, {
  min: 2,           // Minimum connections
  max: 10,          // Maximum connections
  idleTimeoutMillis: 30000,  // Close idle connections after 30s
  connectionTimeoutMillis: 30000,  // Fail if can't connect in 30s
});
```

## Transactions

PostgreSQL provider supports true ACID transactions:

```typescript
const db = getActiveProvider();
const txn = await db.beginTransaction();

try {
  txn.addOperation({ type: 'create', collection: 'platforms', data: platform });
  txn.addOperation({ type: 'create', collection: 'resources', data: resource });
  await txn.commit();
} catch (error) {
  await txn.rollback();
  throw error;
}
```

## SSL Configuration

For production, always use SSL:

```env
# Render, Railway, Heroku, etc.
VITE_POSTGRESQL_URL=postgresql://user:pass@host:5432/db?sslmode=require
VITE_POSTGRESQL_SSL=true
```

```typescript
const pool = createPostgresqlPool(connectionString, {
  ssl: { rejectUnauthorized: false } // For self-signed certs
});
```

## Performance Tips

### 1. Use Indexes

The schema includes indexes, but add more for your queries:

```sql
CREATE INDEX idx_custom ON handshakes(protocol_type, status);
```

### 2. JSONB Queries

Query JSONB fields efficiently:

```sql
-- Find platforms with specific contributor
SELECT * FROM platforms 
WHERE contributors @> '[{"email": "user@example.com"}]';

-- Index JSONB for faster queries
CREATE INDEX idx_contributors ON platforms USING GIN (contributors);
```

### 3. Vacuum Regularly

```sql
VACUUM ANALYZE;
```

### 4. Monitor Connections

```sql
SELECT count(*) FROM pg_stat_activity WHERE datname = 'protocol_os';
```

## Stored Procedures

The schema includes helper functions:

```sql
-- Get full platform tree
SELECT get_platform_tree('platform-uuid-here');

-- Cleanup old logs
SELECT cleanup_old_execution_logs(30); -- Keep 30 days
```

## Backup & Restore

```bash
# Backup
pg_dump protocol_os > backup.sql

# Restore
psql protocol_os < backup.sql

# Backup (compressed)
pg_dump -Fc protocol_os > backup.dump
pg_restore -d protocol_os backup.dump
```

## Cloud PostgreSQL Options

| Provider | Free Tier | Notes |
|----------|-----------|-------|
| [Supabase](https://supabase.com) | 500MB | Use Supabase provider |
| [Neon](https://neon.tech) | 512MB | Serverless, branching |
| [Railway](https://railway.app) | $5 credit | Easy deployment |
| [Render](https://render.com) | 256MB | 90-day free |
| [ElephantSQL](https://elephantsql.com) | 20MB | Good for testing |

## Troubleshooting

### "connection refused"

- Check PostgreSQL is running: `pg_isready`
- Verify host/port in connection string
- Check firewall rules

### "password authentication failed"

- Verify credentials
- Check pg_hba.conf for allowed connections

### "relation does not exist"

- Run schema migration
- Check you're connected to correct database

### "too many connections"

- Increase `max_connections` in postgresql.conf
- Reduce pool `max` setting
- Check for connection leaks

### Slow queries

```sql
-- Enable query logging
ALTER SYSTEM SET log_statement = 'all';
SELECT pg_reload_conf();

-- Check slow queries
SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;
```

---

## When to Use

✅ **Recommended for:**
- Server-side Node.js applications
- Self-hosted deployments
- Complex relational queries
- Existing PostgreSQL infrastructure
- Maximum control over database

❌ **Not recommended for:**
- Browser-only applications (use Supabase)
- Serverless without connection pooling
- Simple key-value storage needs
