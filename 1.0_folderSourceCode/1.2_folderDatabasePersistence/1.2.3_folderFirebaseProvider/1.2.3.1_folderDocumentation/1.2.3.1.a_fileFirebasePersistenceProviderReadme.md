# Firebase Persistence Provider

**Address:** `1.2.3`  
**Type:** Firebase Firestore  
**Setup Required:** Firebase project + security rules

---

## Overview

Firebase provider uses Cloud Firestore, a NoSQL document database with real-time sync and offline support. Ideal for applications needing seamless mobile + web experiences.

## Features

| Feature | Supported |
|---------|-----------|
| Cloud Hosted | ✅ |
| Real-Time Sync | ✅ |
| Offline Persistence | ✅ |
| Multi-User | ✅ |
| Firebase Auth | ✅ |
| Transactions | ✅ |
| Free Tier | ✅ |

## Setup

### 1. Create Firebase Project

1. Go to [console.firebase.google.com](https://console.firebase.google.com)
2. Click "Add project"
3. Follow the setup wizard
4. Enable Firestore in "Build → Firestore Database"

### 2. Get Configuration

1. Go to Project Settings (gear icon)
2. Under "Your apps", click the web icon `</>`
3. Register your app
4. Copy the config object

### 3. Configure Security Rules

In Firebase Console → Firestore → Rules, paste the rules from `1.2.3.b_fileFirebaseClientConfiguration.ts`.

Or deploy via CLI:
```bash
firebase deploy --only firestore:rules
```

### 4. Set Environment Variables

```env
# .env
VITE_FIREBASE_API_KEY=AIza...
VITE_FIREBASE_PROJECT_ID=my-project-id
VITE_FIREBASE_AUTH_DOMAIN=my-project-id.firebaseapp.com
VITE_FIREBASE_STORAGE_BUCKET=my-project-id.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=123456789
VITE_FIREBASE_APP_ID=1:123456789:web:abc123

# Optional
VITE_DB_DEBUG=true
```

### 5. Switch Provider

```typescript
// In 1.2.c_fileActiveDatabaseProviderToggle.ts
const ACTIVE_PROVIDER: DatabaseProviderType = 'firebase';
```

## Data Structure

Firestore stores data as collections of documents:

```
firestore/
├── platforms/
│   └── {platformId}
│       ├── serial: "PLAT-ABCD"
│       ├── name: "Anthropic Claude"
│       ├── url: "https://api.anthropic.com"
│       ├── isMaster: true
│       ├── createdAt: Timestamp
│       └── updatedAt: Timestamp
├── resources/
│   └── {resourceId}
│       ├── platformId: "platforms/{id}"
│       ├── serial: "RES-WXYZ"
│       └── ...
├── handshakes/
│   └── {handshakeId}
│       ├── resourceId: "resources/{id}"
│       └── ...
└── executionLogs/
    └── {logId}
        └── ...
```

## Offline Support

Firebase automatically caches data for offline access:

```typescript
// Already enabled by default in the provider
import { enableIndexedDbPersistence } from 'firebase/firestore';
await enableIndexedDbPersistence(db);
```

When offline:
- Read operations return cached data
- Write operations are queued
- Syncs automatically when online

## Real-Time Listeners

Subscribe to real-time updates:

```typescript
import { onSnapshot, collection } from 'firebase/firestore';

const unsubscribe = onSnapshot(
  collection(db, 'platforms'),
  (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === 'added') {
        console.log('New platform:', change.doc.data());
      }
      if (change.type === 'modified') {
        console.log('Updated platform:', change.doc.data());
      }
      if (change.type === 'removed') {
        console.log('Removed platform:', change.doc.id);
      }
    });
  }
);

// Later: unsubscribe();
```

## Firebase Authentication

Integrate with Firebase Auth for user-specific data:

```typescript
import { getAuth, signInWithPopup, GoogleAuthProvider } from 'firebase/auth';

const auth = getAuth();
await signInWithPopup(auth, new GoogleAuthProvider());

// User is now authenticated
// Security rules will apply based on auth.uid
```

## Local Development

Use Firebase Emulator for local development:

```bash
# Install Firebase CLI
npm install -g firebase-tools

# Start emulators
firebase emulators:start --only firestore,auth

# Connect your app
```

```typescript
import { connectFirestoreEmulator } from 'firebase/firestore';

if (import.meta.env.DEV) {
  connectFirestoreEmulator(db, 'localhost', 8080);
}
```

## Pricing

| Tier | Reads | Writes | Storage |
|------|-------|--------|---------|
| Spark (Free) | 50K/day | 20K/day | 1GB |
| Blaze (Pay-as-you-go) | $0.06/100K | $0.18/100K | $0.108/GB |

## Troubleshooting

### "Missing or insufficient permissions"

Security rules are blocking the operation. Check:
- User is authenticated
- Rules allow the operation
- Document path matches rule pattern

### "Failed to enable persistence"

Persistence can only be enabled once. This error is usually harmless.

### "Quota exceeded"

Free tier limits reached. Options:
- Wait for daily reset
- Upgrade to Blaze plan
- Optimize queries to reduce reads

### Data not syncing

Check:
- Internet connection
- Firebase project is active
- No security rule violations

## Indexes

For complex queries, create composite indexes:

```json
// firestore.indexes.json
{
  "indexes": [
    {
      "collectionGroup": "handshakes",
      "fields": [
        { "fieldPath": "resourceId", "order": "ASCENDING" },
        { "fieldPath": "status", "order": "ASCENDING" }
      ]
    }
  ]
}
```

Deploy:
```bash
firebase deploy --only firestore:indexes
```

---

## When to Use

✅ **Recommended for:**
- Real-time applications
- Mobile + web apps
- Offline-first requirements
- Rapid prototyping
- Firebase ecosystem users

❌ **Not recommended for:**
- Complex relational queries
- Heavy aggregations
- Cost-sensitive high-volume apps
- SQL database requirements
