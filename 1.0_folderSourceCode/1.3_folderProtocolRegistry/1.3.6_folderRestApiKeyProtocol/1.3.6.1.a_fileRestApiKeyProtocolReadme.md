# REST API Key Protocol

> **Address:** 1.3.6  
> **Type:** Protocol Module  
> **Status:** âœ… Production Ready  
> **Version:** 1.0.0

---

## Overview

API Key authentication is the **simplest** and **most common** form of API authentication. A static secret token is included with each request to identify and authorize the caller.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Your Service   â”‚                    â”‚   API Provider   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                       â”‚
         â”‚  Request + API Key                    â”‚
         â”‚  (Header, Query, or Body)             â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
         â”‚                                       â”‚
         â”‚  Response                             â”‚
         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                                       â”‚
         â–¼                                       â–¼
```

---

## When to Use This Module

| Use Case | Recommended? |
|----------|--------------|
| Third-party API integrations | âœ… Yes |
| Backend service calls | âœ… Yes |
| CLI tools and scripts | âœ… Yes |
| Scheduled jobs / cron | âœ… Yes |
| Internal microservices | âœ… Yes |
| Browser/SPA applications | âŒ No |
| Mobile apps | âŒ No |

---

## Quick Start

### 1. Configure API Key

```typescript
const credentials = {
  apiKey: process.env.API_KEY, // From environment!
  placement: 'header',
  headerFormat: 'authorization-bearer',
  baseUrl: 'https://api.example.com',
  healthCheckPath: '/v1/me',
};
```

### 2. Use the Executor

```typescript
import { RestApiKeyHandshakeExecutor } from './1.3.6.a_fileRestApiKeyHandshakeExecutor';

const executor = new RestApiKeyHandshakeExecutor();

// Test the key
const authResult = await executor.authenticate(credentials);
if (authResult.type === 'complete') {
  console.log('API key configured successfully');
}
```

### 3. Make API Requests

```typescript
const result = await executor.executeRequest({
  credentials,
  url: 'https://api.example.com/v1/data',
  method: 'GET',
  headers: { 'Content-Type': 'application/json' },
});

if (result.success) {
  console.log('Response:', result.body);
}
```

---

## Key Placement Options

### 1. HTTP Header (Recommended)

```typescript
// X-API-Key header
const credentials = {
  apiKey: 'your-api-key',
  placement: 'header',
  headerFormat: 'x-api-key',
};
// Result: X-API-Key: your-api-key

// Authorization: Bearer
const credentials = {
  apiKey: 'your-api-key',
  placement: 'header',
  headerFormat: 'authorization-bearer',
};
// Result: Authorization: Bearer your-api-key

// Custom header
const credentials = {
  apiKey: 'your-api-key',
  placement: 'header',
  headerFormat: 'custom',
  customHeaderName: 'X-My-Auth',
  customHeaderPrefix: 'Token ',
};
// Result: X-My-Auth: Token your-api-key
```

### 2. Query Parameter

```typescript
const credentials = {
  apiKey: 'your-api-key',
  placement: 'query',
  queryParamName: 'api_key',
};
// Result: ?api_key=your-api-key
```

âš ï¸ **Warning:** Query parameters may appear in server logs and browser history.

### 3. Request Body

```typescript
const credentials = {
  apiKey: 'your-api-key',
  placement: 'body',
  bodyFieldName: 'api_key',
};
// Result: { "api_key": "your-api-key", ...otherData }
```

---

## Supported Providers

| Provider | Header Format | Key Prefix | Notes |
|----------|--------------|------------|-------|
| Stripe | Bearer | `sk_live_` | Secret key for server-side |
| OpenAI | Bearer | `sk-` | API key |
| Anthropic | x-api-key | `sk-ant-` | Also needs version header |
| SendGrid | Bearer | `SG.` | API key |
| Twilio | Basic Auth | - | Account SID + Auth Token |
| GitHub | Bearer | `ghp_` | Personal access token |
| Slack | Bearer | `xoxb-` | Bot token |
| Notion | Bearer | `secret_` | Integration token |
| Airtable | Bearer | `pat` | Personal access token |
| Cloudflare | Bearer | - | API token |

---

## Header Format Reference

| Format | HTTP Header |
|--------|-------------|
| `x-api-key` | `X-API-Key: {key}` |
| `authorization-bearer` | `Authorization: Bearer {key}` |
| `authorization-apikey` | `Authorization: ApiKey {key}` |
| `authorization-basic` | `Authorization: Basic base64(:{key})` |
| `authorization-token` | `Authorization: Token {key}` |
| `custom` | `{customHeaderName}: {customHeaderPrefix}{key}` |

---

## Configuration Reference

### Required Fields

| Field | Description | Example |
|-------|-------------|---------|
| `apiKey` | Your API key | `sk_live_xxxxx` |
| `placement` | Where to put the key | `header`, `query`, `body` |

### Optional Fields

| Field | Description | Default |
|-------|-------------|---------|
| `headerFormat` | Header style | `x-api-key` |
| `customHeaderName` | Custom header name | - |
| `customHeaderPrefix` | Prefix before key | - |
| `queryParamName` | Query param name | `api_key` |
| `bodyFieldName` | JSON field name | `api_key` |
| `baseUrl` | API base URL | - |
| `healthCheckPath` | Test endpoint | - |
| `secondaryApiKey` | For key pairs | - |

---

## Security Best Practices

### ğŸ” Key Storage

```typescript
// âœ… GOOD: Environment variable
const apiKey = process.env.STRIPE_API_KEY;

// âœ… GOOD: Secrets manager
const apiKey = await secretsManager.getSecret('stripe-api-key');

// âŒ BAD: Hardcoded
const apiKey = 'sk_live_xxxxxxxxxxxxx';
```

### ğŸ”„ Key Rotation

```
1. Generate new key in provider dashboard
2. Update environment variables
3. Deploy new key
4. Wait for in-flight requests (grace period)
5. Revoke old key
```

### ğŸ“Š Monitoring

- Track API usage per key
- Alert on unusual patterns
- Monitor rate limits
- Log key usage (not the key itself!)

---

## Key Detection

The executor can automatically detect some key formats:

```typescript
const keyInfo = RestApiKeyHandshakeExecutor.detectKeyFormat('sk_live_xxx');
// { provider: 'Stripe', type: 'Secret Key', environment: 'live' }

const keyInfo = RestApiKeyHandshakeExecutor.detectKeyFormat('sk-xxx');
// { provider: 'OpenAI', type: 'API Key', environment: 'unknown' }

const keyInfo = RestApiKeyHandshakeExecutor.detectKeyFormat('SG.xxx.xxx');
// { provider: 'SendGrid', type: 'API Key', environment: 'unknown' }
```

---

## Key Masking

Display keys safely:

```typescript
const masked = RestApiKeyHandshakeExecutor.maskApiKey('sk_live_abcd1234efgh5678');
// 'sk_lâ€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢5678'

const masked = RestApiKeyHandshakeExecutor.maskApiKey('short_key', 2);
// 'shâ€¢â€¢â€¢â€¢ey'
```

---

## Error Handling

### Common Error Codes

| Code | Meaning | Solution |
|------|---------|----------|
| `UNAUTHORIZED` (401) | Invalid API key | Check key is correct |
| `FORBIDDEN` (403) | Key lacks permission | Check key scopes |
| `RATE_LIMITED` (429) | Too many requests | Implement backoff |
| `NOT_FOUND` (404) | Endpoint not found | Check URL |
| `SERVER_ERROR` (5xx) | Provider error | Retry with backoff |

### Example Error Handling

```typescript
const result = await executor.executeRequest(context);

switch (result.errorCode) {
  case 'UNAUTHORIZED':
    console.error('API key is invalid or revoked');
    break;
  case 'RATE_LIMITED':
    const retryAfter = result.headers['retry-after'] || 60;
    console.log(`Rate limited. Retry after ${retryAfter}s`);
    await sleep(retryAfter * 1000);
    // Retry...
    break;
  case 'SERVER_ERROR':
    console.error('Provider error, retrying...');
    // Exponential backoff retry
    break;
}
```

---

## Rate Limit Handling

```typescript
async function apiCallWithRetry(context, maxRetries = 3) {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    const result = await executor.executeRequest(context);
    
    if (result.success) {
      return result;
    }
    
    if (result.errorCode === 'RATE_LIMITED') {
      const backoff = Math.pow(2, attempt) * 1000; // Exponential
      const jitter = Math.random() * 1000; // Add jitter
      await sleep(backoff + jitter);
      continue;
    }
    
    // Non-retryable error
    throw new Error(result.error);
  }
  
  throw new Error('Max retries exceeded');
}
```

---

## Health Check

Test if an API key is valid:

```typescript
const result = await executor.healthCheck(credentials);

if (result.healthy) {
  console.log('API key is valid');
  console.log('Latency:', result.latencyMs, 'ms');
} else {
  console.error('API key issue:', result.message);
}
```

---

## Provider-Specific Examples

### Stripe

```typescript
const credentials = {
  apiKey: process.env.STRIPE_SECRET_KEY,
  placement: 'header',
  headerFormat: 'authorization-bearer',
  baseUrl: 'https://api.stripe.com',
  healthCheckPath: '/v1/balance',
};
```

### OpenAI

```typescript
const credentials = {
  apiKey: process.env.OPENAI_API_KEY,
  placement: 'header',
  headerFormat: 'authorization-bearer',
  baseUrl: 'https://api.openai.com',
  healthCheckPath: '/v1/models',
};
```

### Anthropic

```typescript
const credentials = {
  apiKey: process.env.ANTHROPIC_API_KEY,
  placement: 'header',
  headerFormat: 'custom',
  customHeaderName: 'x-api-key',
  baseUrl: 'https://api.anthropic.com',
};

// Note: Also requires anthropic-version header in requests
```

### GitHub

```typescript
const credentials = {
  apiKey: process.env.GITHUB_TOKEN,
  placement: 'header',
  headerFormat: 'authorization-bearer',
  baseUrl: 'https://api.github.com',
  healthCheckPath: '/user',
};
```

---

## Comparison with Other Auth

| Feature | API Key | OAuth 2.0 | JWT |
|---------|---------|-----------|-----|
| Complexity | Very Low | High | Medium |
| Expiration | None* | Yes | Yes |
| User Context | No | Yes | Yes |
| Scopes | At creation | Dynamic | In token |
| Refresh | N/A | Yes | Yes |

*Unless manually rotated

---

## Troubleshooting

### "401 Unauthorized"

1. Verify the API key is correct
2. Check the key hasn't been revoked
3. Verify the header format matches provider requirements
4. Ensure no extra whitespace in the key

### "403 Forbidden"

1. Check key permissions/scopes
2. Verify you're accessing an allowed resource
3. Check IP restrictions on the key

### "429 Rate Limited"

1. Implement exponential backoff
2. Check your usage against limits
3. Consider upgrading your plan
4. Cache responses where possible

---

## Files in This Module

| File | Purpose |
|------|---------|
| `1.3.6.a_fileRestApiKeyHandshakeExecutor.ts` | Core API key injection |
| `1.3.6.b_fileRestApiKeyCredentialFormFields.tsx` | React configuration UI |
| `1.3.6.c_fileRestApiKeyWhitepaperDocumentation.ts` | Technical specification |
| `1.3.6.1.a_fileRestApiKeyProtocolReadme.md` | This documentation |

---

## Related Resources

- [API Security Best Practices](https://owasp.org/www-project-api-security/)
- [HTTP Authentication (MDN)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-03 | Initial release |

---

*Protocol OS - Configure once, connect anywhere.*
