# WebSocket Protocol

> **Address:** 1.3.8  
> **Type:** Protocol Module  
> **Status:** ✅ Production Ready  
> **Version:** 1.0.0

---

## Overview

WebSocket provides **full-duplex, bidirectional** communication over a single TCP connection. Unlike HTTP's request-response model, WebSocket enables real-time data flow in both directions simultaneously.

```
┌──────────────────┐                    ┌──────────────────┐
│     Client       │                    │     Server       │
└────────┬─────────┘                    └────────┬─────────┘
         │                                       │
         │  HTTP Upgrade Request                 │
         │──────────────────────────────────────▶│
         │                                       │
         │  101 Switching Protocols              │
         │◀──────────────────────────────────────│
         │                                       │
         │  ═══════ WebSocket Open ═══════════  │
         │                                       │
         │  Message →                            │
         │──────────────────────────────────────▶│
         │                                       │
         │                            ← Message  │
         │◀──────────────────────────────────────│
         │                                       │
         │  (bidirectional, full-duplex)         │
         │                                       │
         ▼                                       ▼
```

---

## Key Features

| Feature | Description |
|---------|-------------|
| Persistent | Connection stays open |
| Bidirectional | Client ↔ Server any time |
| Low Latency | No HTTP overhead per message |
| Full-Duplex | Send & receive simultaneously |
| Lightweight | 2-14 byte frame headers |

---

## When to Use This Module

| Use Case | Recommended? |
|----------|--------------|
| Real-time chat | ✅ Yes |
| Live data feeds | ✅ Yes |
| Collaborative editing | ✅ Yes |
| Gaming multiplayer | ✅ Yes |
| IoT communication | ✅ Yes |
| Live notifications | ✅ Yes |
| Simple REST calls | ❌ Use HTTP |
| File uploads | ❌ Use HTTP |

---

## Quick Start

### 1. Configure Connection

```typescript
const credentials = {
  url: 'wss://api.example.com/ws',
  authMethod: 'query-param',
  authToken: process.env.WS_TOKEN,
  tokenParamName: 'token',
  messageFormat: 'json',
  autoReconnect: true,
  pingInterval: 30000,
};
```

### 2. Create Executor

```typescript
import { WebSocketHandshakeExecutor } from './1.3.8.a_fileWebsocketHandshakeExecutor';

const executor = new WebSocketHandshakeExecutor();

// Set up event handlers
executor.setEventHandlers({
  onOpen: () => console.log('Connected!'),
  onClose: (event) => console.log('Closed:', event.code),
  onMessage: (data) => console.log('Received:', data),
  onStateChange: (state) => console.log('State:', state),
  onReconnect: (attempt) => console.log('Reconnecting...', attempt),
});
```

### 3. Connect

```typescript
const result = await executor.connect(credentials);

if (result.success) {
  console.log('WebSocket connected!');
}
```

### 4. Send Messages

```typescript
// Send JSON message
executor.send({ type: 'chat', message: 'Hello!' });

// Send via protocol interface
await executor.executeRequest({
  credentials,
  url: '', // Not used for WebSocket
  method: 'POST',
  headers: {},
  body: { type: 'subscribe', channel: 'updates' },
});
```

### 5. Disconnect

```typescript
executor.disconnect(1000, 'User logged out');
```

---

## Authentication Methods

### 1. Query Parameter (Most Common)

```typescript
const credentials = {
  url: 'wss://api.example.com/ws',
  authMethod: 'query-param',
  authToken: 'your-token',
  tokenParamName: 'token',
};
// Result: wss://api.example.com/ws?token=your-token
```

### 2. First Message Authentication

```typescript
const credentials = {
  url: 'wss://api.example.com/ws',
  authMethod: 'first-message',
  authToken: 'your-token',
  authMessageType: 'authenticate',
  authMessageTemplate: '{"type": "{{type}}", "token": "{{token}}"}',
};
// Connects first, then sends: {"type": "authenticate", "token": "your-token"}
```

### 3. Subprotocol Authentication

```typescript
const credentials = {
  url: 'wss://api.example.com/ws',
  authMethod: 'subprotocol',
  authToken: 'your-token',
};
// Token sent in Sec-WebSocket-Protocol header
```

### 4. No Authentication

```typescript
const credentials = {
  url: 'wss://echo.websocket.events',
  authMethod: 'none',
};
```

---

## Supported Providers

| Provider | Auth Method | Subprotocol | Notes |
|----------|-------------|-------------|-------|
| Socket.IO | first-message | - | EIO=4 for v4+ |
| Pusher | first-message | - | pusher:subscribe |
| Ably | query-param | - | key param |
| Phoenix Channels | query-param | - | token param |
| Action Cable | query-param | - | Rails WebSocket |
| SignalR | query-param | - | access_token |
| GraphQL WS | first-message | graphql-transport-ws | connection_init |
| Apollo Legacy | first-message | graphql-ws | connection_init |
| AWS API Gateway | query-param | - | Authorization |
| Binance Streams | none | - | Public market data |
| Echo Server | none | - | Test/debug |

---

## Connection Manager

For advanced use cases, use the `WebSocketConnectionManager`:

```typescript
import { WebSocketConnectionManager } from './1.3.8.d_fileWebsocketConnectionManager';

const manager = new WebSocketConnectionManager({
  url: 'wss://api.example.com/ws',
  authMethod: 'query-param',
  authToken: 'your-token',
  messageFormat: 'json',
  autoReconnect: true,
});

// Connect
await manager.connect();

// Subscribe to channels
const subId = manager.subscribe('chat', (message) => {
  console.log('Chat message:', message);
});

// Request/Response pattern
const response = await manager.request('getUser', { id: '123' });

// Publish to channel
manager.publish('chat', { text: 'Hello!' });

// Get statistics
const stats = manager.getStats();
console.log('Messages received:', stats.messagesReceived);
console.log('Latency:', stats.latencyMs, 'ms');

// Unsubscribe
manager.unsubscribe(subId);

// Disconnect
manager.disconnect();
```

---

## Configuration Reference

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `url` | URL | WebSocket endpoint (wss:// or ws://) |
| `authMethod` | Select | Authentication method |
| `messageFormat` | Select | Message format (json/text/binary) |

### Optional Fields

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `authToken` | Secret | - | Authentication token |
| `tokenParamName` | Text | `token` | Query param name |
| `authMessageType` | Text | `authenticate` | Auth message type |
| `authMessageTemplate` | JSON | - | Auth message template |
| `subprotocols` | Text | - | Comma-separated subprotocols |
| `pingInterval` | Number | 30000 | Ping interval (ms) |
| `pongTimeout` | Number | 5000 | Pong timeout (ms) |
| `autoReconnect` | Boolean | true | Auto-reconnect |
| `maxReconnectAttempts` | Number | 10 | Max reconnect tries |
| `reconnectDelay` | Number | 1000 | Initial reconnect delay |

---

## Connection States

```typescript
type WebSocketConnectionState = 
  | 'disconnected'    // Not connected
  | 'connecting'      // TCP handshake in progress
  | 'connected'       // WebSocket open
  | 'authenticating'  // Sending auth message
  | 'authenticated'   // Ready to use
  | 'reconnecting'    // Auto-reconnecting
  | 'error';          // Connection failed
```

---

## Close Codes

| Code | Meaning | Action |
|------|---------|--------|
| 1000 | Normal closure | Clean close |
| 1001 | Going away | Page unload/server shutdown |
| 1002 | Protocol error | Bug in client/server |
| 1003 | Unsupported data | Wrong message format |
| 1006 | Abnormal closure | Connection lost |
| 1008 | Policy violation | Auth/security issue |
| 1009 | Message too big | Reduce message size |
| 1011 | Server error | Try again later |
| 1012 | Service restart | Auto-reconnect |
| 1013 | Try again later | Back off & retry |

---

## Keep-Alive (Ping/Pong)

```typescript
const credentials = {
  // ... other config
  pingInterval: 30000,  // Send ping every 30s
  pongTimeout: 5000,    // Wait 5s for pong
};

// The executor automatically:
// 1. Sends ping messages at pingInterval
// 2. Waits for pong response
// 3. Disconnects if no pong received
```

---

## Auto-Reconnection

```typescript
const credentials = {
  // ... other config
  autoReconnect: true,
  maxReconnectAttempts: 10,  // 0 = unlimited
  reconnectDelay: 1000,       // Initial delay (exponential backoff)
};

// Reconnection uses exponential backoff with jitter:
// Attempt 1: ~1s
// Attempt 2: ~2s
// Attempt 3: ~4s
// ...
// Capped at 30s
```

---

## Provider-Specific Examples

### GraphQL Subscriptions (graphql-ws)

```typescript
const credentials = {
  url: 'wss://api.example.com/graphql',
  authMethod: 'first-message',
  authToken: 'your-jwt-token',
  authMessageTemplate: '{"type": "connection_init", "payload": {"authorization": "Bearer {{token}}"}}',
  subprotocols: 'graphql-transport-ws',
};
```

### Socket.IO

```typescript
const credentials = {
  url: 'wss://server.com/socket.io/?EIO=4&transport=websocket',
  authMethod: 'first-message',
  authToken: 'your-token',
  authMessageTemplate: '42["auth",{"token":"{{token}}"}]',
};
```

### Binance Market Data (Public)

```typescript
const credentials = {
  url: 'wss://stream.binance.com:9443/ws',
  authMethod: 'none',
  messageFormat: 'json',
};

// Subscribe to streams
executor.send({
  method: 'SUBSCRIBE',
  params: ['btcusdt@ticker'],
  id: 1
});
```

---

## Error Handling

```typescript
executor.setEventHandlers({
  onError: (event) => {
    console.error('WebSocket error:', event);
  },
  onClose: (event) => {
    if (!event.wasClean) {
      console.error('Abnormal close:', event.code, event.reason);
    }
    
    const reason = WebSocketHandshakeExecutor.getCloseReason(event.code);
    console.log('Close reason:', reason);
  },
});
```

---

## Message Utilities

```typescript
// Create a typed message
const msg = WebSocketHandshakeExecutor.createMessage(
  'chat',           // type
  { text: 'Hi!' },  // payload
  'msg-123'         // optional id
);
// { type: 'chat', payload: {...}, id: 'msg-123', timestamp: ... }

// Parse incoming message
const parsed = WebSocketHandshakeExecutor.parseMessage(event.data);

// Get close code meaning
const meaning = WebSocketHandshakeExecutor.getCloseReason(1006);
// 'Abnormal closure (no close frame)'
```

---

## Best Practices

### Connection Management

- ✅ Use `wss://` in production (encrypted)
- ✅ Implement auto-reconnection
- ✅ Use exponential backoff with jitter
- ✅ Handle page visibility changes

### Authentication

- ✅ Prefer first-message auth over URL tokens
- ✅ Implement token refresh mechanism
- ✅ Handle auth failures gracefully

### Messages

- ✅ Use JSON with type/id fields
- ✅ Implement request/response correlation
- ✅ Queue messages during reconnection

### Performance

- ✅ Use binary for large payloads
- ✅ Batch small messages
- ✅ Clean up on disconnect

---

## Troubleshooting

### Connection Timeout

1. Verify URL is correct (wss:// vs ws://)
2. Check firewall/proxy settings
3. Verify server is accepting connections

### Authentication Failed

1. Check token is valid and not expired
2. Verify auth method matches server expectations
3. Check auth message format

### Frequent Disconnections

1. Implement keep-alive (ping/pong)
2. Check network stability
3. Verify server timeout settings
4. Enable auto-reconnect

### Messages Not Received

1. Verify connection state is 'authenticated'
2. Check message format matches server
3. Verify subscription is active

---

## Files in This Module

| File | Purpose |
|------|---------|
| `1.3.8.a_fileWebsocketHandshakeExecutor.ts` | Core WebSocket executor |
| `1.3.8.b_fileWebsocketCredentialFormFields.tsx` | React configuration UI |
| `1.3.8.c_fileWebsocketWhitepaperDocumentation.ts` | Technical specification |
| `1.3.8.d_fileWebsocketConnectionManager.ts` | Advanced connection manager |
| `1.3.8.1.a_fileWebsocketProtocolReadme.md` | This documentation |

---

## Related Resources

- [RFC 6455 - WebSocket Protocol](https://datatracker.ietf.org/doc/html/rfc6455)
- [MDN WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
- [Socket.IO Documentation](https://socket.io/docs/v4/)
- [graphql-ws Protocol](https://github.com/enisdenjo/graphql-ws)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-03 | Initial release |

---

*Protocol OS - Configure once, connect anywhere.*
