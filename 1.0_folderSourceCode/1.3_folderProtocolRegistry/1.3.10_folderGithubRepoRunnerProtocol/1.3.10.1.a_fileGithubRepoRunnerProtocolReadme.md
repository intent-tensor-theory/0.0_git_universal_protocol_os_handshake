# GitHub Repo Runner Protocol

> **Address:** 1.3.10  
> **Type:** Protocol Module  
> **Status:** ✅ Production Ready  
> **Version:** 1.0.0

---

## Overview

The GitHub Repo Runner Protocol provides authentication and API access for GitHub repositories, Actions workflows, and self-hosted runners. It supports multiple authentication methods including Personal Access Tokens, GitHub Apps, and runner registration tokens.

```
┌──────────────────┐                    ┌──────────────────┐
│     Client       │                    │   GitHub API     │
└────────┬─────────┘                    └────────┬─────────┘
         │                                       │
         │  GET /repos/owner/repo                │
         │  Authorization: Bearer ghp_xxx        │
         │  Accept: application/vnd.github+json  │
         │  X-GitHub-Api-Version: 2022-11-28     │
         │──────────────────────────────────────▶│
         │                                       │
         │  200 OK                               │
         │  X-RateLimit-Remaining: 4999          │
         │  { "name": "repo", ... }              │
         │◀──────────────────────────────────────│
         │                                       │
         ▼                                       ▼
```

---

## Key Features

| Feature | Description |
|---------|-------------|
| Multiple Auth Methods | PAT, Fine-Grained PAT, GitHub App, OAuth |
| REST API v3 | Full GitHub REST API support |
| GraphQL API v4 | Complex queries with single request |
| Actions Integration | Trigger workflows, manage runners |
| Enterprise Support | GitHub Enterprise Server compatible |

---

## When to Use This Module

| Use Case | Recommended? |
|----------|--------------|
| Repository automation | ✅ Yes |
| CI/CD pipelines | ✅ Yes |
| Self-hosted runners | ✅ Yes |
| GitHub Actions workflows | ✅ Yes |
| Package registry access | ✅ Yes |
| Issue/PR automation | ✅ Yes |
| Webhook management | ✅ Yes |

---

## Quick Start

### 1. Configure Authentication

```typescript
// Using Personal Access Token
const credentials = {
  authMethod: 'pat',
  token: process.env.GITHUB_TOKEN,
  repository: 'owner/repo',
};

// Using GitHub App
const appCredentials = {
  authMethod: 'github-app',
  appId: '123456',
  privateKey: process.env.GITHUB_APP_KEY,
  installationId: '12345678',
};
```

### 2. Create Executor

```typescript
import { GitHubRepoRunnerHandshakeExecutor } from './1.3.10.a_fileGithubRepoRunnerHandshakeExecutor';

const executor = new GitHubRepoRunnerHandshakeExecutor();

// Authenticate
const authResult = await executor.authenticate(credentials);
if (authResult.type === 'complete') {
  console.log('Authenticated:', authResult.data.user);
}
```

### 3. Make API Calls

```typescript
// Get repository info
const repo = await executor.getRepository(credentials, 'owner', 'repo');
console.log('Repository:', repo.repository?.fullName);

// Execute custom request
const result = await executor.executeRequest({
  credentials,
  url: '/repos/owner/repo/commits',
  method: 'GET',
  headers: {},
});
```

---

## Authentication Methods

### 1. Personal Access Token (Classic)

```typescript
const credentials = {
  authMethod: 'pat',
  token: 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxx',
};
```

**Token Format:** `ghp_` prefix  
**Scopes:** OAuth-style (repo, workflow, admin:org, etc.)  
**Create at:** Settings → Developer Settings → Personal Access Tokens

### 2. Fine-Grained PAT

```typescript
const credentials = {
  authMethod: 'fine-grained-pat',
  token: 'github_pat_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
};
```

**Token Format:** `github_pat_` prefix  
**Permissions:** Repository-specific, granular  
**Expiration:** Required (max 1 year)

### 3. GitHub App

```typescript
const credentials = {
  authMethod: 'github-app',
  appId: '123456',
  privateKey: `-----BEGIN RSA PRIVATE KEY-----
...
-----END RSA PRIVATE KEY-----`,
  installationId: '12345678',
};
```

**Best for:** Organizational automation, CI/CD  
**Token Type:** `ghs_` (installation token)  
**Expiration:** 1 hour (auto-refresh supported)

### 4. Runner Registration Token

```typescript
const credentials = {
  authMethod: 'runner-token',
  runnerToken: 'AXXXXXXXXXXXXXXXXXXXXXXXXXX',
};
```

**Purpose:** Register self-hosted runners  
**Expiration:** 1 hour  
**Single Use:** Consumed during registration

---

## Token Prefixes

| Prefix | Type |
|--------|------|
| `ghp_` | Classic Personal Access Token |
| `github_pat_` | Fine-Grained PAT |
| `gho_` | OAuth Access Token |
| `ghs_` | GitHub App Installation Token |
| `ghr_` | GitHub App Refresh Token |

---

## API Usage

### REST API

```typescript
// Get repository
const result = await executor.executeRequest({
  credentials,
  url: '/repos/owner/repo',
  method: 'GET',
  headers: {},
});

// Create issue
const issue = await executor.executeRequest({
  credentials,
  url: '/repos/owner/repo/issues',
  method: 'POST',
  headers: {},
  body: {
    title: 'Bug Report',
    body: 'Description here...',
    labels: ['bug'],
  },
});
```

### GraphQL API

```typescript
const result = await executor.graphql(credentials, `
  query($owner: String!, $name: String!) {
    repository(owner: $owner, name: $name) {
      name
      stargazerCount
      forkCount
      issues(first: 5, states: OPEN) {
        nodes {
          title
          createdAt
        }
      }
    }
  }
`, {
  owner: 'octocat',
  name: 'Hello-World',
});

if (result.success) {
  console.log('Stars:', result.data?.repository?.stargazerCount);
}
```

---

## GitHub Actions Integration

### Trigger Workflow

```typescript
await executor.triggerWorkflow(
  credentials,
  'owner',
  'repo',
  'deploy.yml',  // workflow file or ID
  'main',         // ref (branch/tag)
  {               // inputs
    environment: 'production',
    version: 'v1.2.3',
  }
);
```

### List Runners

```typescript
const runners = await executor.listOrgRunners(credentials, 'my-org');
for (const runner of runners.runners || []) {
  console.log(`${runner.name}: ${runner.status} (busy: ${runner.busy})`);
}
```

### Get Runner Registration Token

```typescript
// For repository
const repoToken = await executor.getRunnerRegistrationToken(
  credentials,
  'owner',
  'repo'
);

// For organization
const orgToken = await executor.getRunnerRegistrationToken(
  credentials,
  'my-org'
);

console.log('Token:', repoToken.token);
console.log('Expires:', repoToken.expiresAt);
```

---

## Configuration Reference

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `authMethod` | Select | Authentication method |

### Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `token` | Secret | PAT or OAuth token |
| `appId` | Text | GitHub App ID |
| `privateKey` | Textarea | GitHub App private key |
| `installationId` | Text | App installation ID |
| `runnerToken` | Secret | Runner registration token |
| `repository` | Text | Target repo (owner/repo) |
| `organization` | Text | Target organization |
| `enterpriseUrl` | URL | GitHub Enterprise Server URL |
| `apiVersion` | Select | REST or GraphQL |
| `timeout` | Number | Request timeout (ms) |

---

## Rate Limits

### REST API

| Auth Type | Limit |
|-----------|-------|
| Unauthenticated | 60/hour |
| PAT | 5,000/hour |
| GitHub App | 5,000/hour per installation |
| GITHUB_TOKEN | 1,000/hour |

### Rate Limit Headers

```
X-RateLimit-Limit: 5000
X-RateLimit-Remaining: 4990
X-RateLimit-Reset: 1697312400
X-RateLimit-Used: 10
```

### GraphQL API

Point-based system (5,000 points/hour). Query complexity determines point cost.

---

## Health Check

```typescript
const health = await executor.healthCheck(credentials);

if (health.healthy) {
  console.log('API healthy');
  console.log('Rate limit:', health.details.rateLimit);
  console.log('User:', health.details.user?.login);
}
```

---

## Error Handling

```typescript
const result = await executor.executeRequest(context);

if (!result.success) {
  switch (result.statusCode) {
    case 401:
      console.error('Invalid or expired token');
      break;
    case 403:
      if (result.headers['x-ratelimit-remaining'] === '0') {
        const resetTime = new Date(parseInt(result.headers['x-ratelimit-reset']) * 1000);
        console.error('Rate limited. Resets at:', resetTime);
      } else {
        console.error('Forbidden - check permissions');
      }
      break;
    case 404:
      console.error('Resource not found');
      break;
    case 422:
      console.error('Validation error:', result.body);
      break;
    default:
      console.error('Error:', result.error);
  }
}
```

---

## GitHub Enterprise Server

```typescript
const credentials = {
  authMethod: 'pat',
  token: 'ghp_xxxxx',
  enterpriseUrl: 'https://github.mycompany.com',
};

// API calls automatically use:
// https://github.mycompany.com/api/v3/...
```

---

## Best Practices

### Authentication

- ✅ Use fine-grained PATs for minimal permissions
- ✅ Use GitHub Apps for organizational automation
- ✅ Set expiration dates on all tokens
- ✅ Store tokens in secret managers
- ✅ Never commit tokens to repositories

### API Usage

- ✅ Include `X-GitHub-Api-Version` header
- ✅ Check rate limits before bulk operations
- ✅ Use conditional requests (ETag) for caching
- ✅ Use GraphQL for complex data needs
- ✅ Handle pagination properly

### Self-Hosted Runners

- ✅ Run as non-root user
- ✅ Use ephemeral runners for sensitive workloads
- ✅ Keep runner software updated
- ✅ Use runner groups for access control

---

## Utility Methods

```typescript
// Parse repository string
const parsed = GitHubRepoRunnerHandshakeExecutor.parseRepository('owner/repo');
// { owner: 'owner', repo: 'repo' }

// Identify token type
const type = GitHubRepoRunnerHandshakeExecutor.getTokenType('ghp_xxx');
// 'classic-pat'

// Mask token for display
const masked = GitHubRepoRunnerHandshakeExecutor.maskToken('ghp_abcdefghijk');
// 'ghp_...hijk'
```

---

## Troubleshooting

### "Bad credentials" (401)

1. Verify token is correct and not expired
2. Check token has required scopes/permissions
3. For GitHub Apps, ensure installation ID is correct

### "Forbidden" (403)

1. Check rate limit headers
2. Verify token has required permissions
3. For organization resources, ensure membership

### "Not Found" (404)

1. Check repository/resource exists
2. Verify token has access (private repos need `repo` scope)
3. Check owner/repo spelling

### Rate Limited

1. Wait until reset time (check `X-RateLimit-Reset`)
2. Implement exponential backoff
3. Use conditional requests to save quota
4. Consider GitHub App for higher limits

---

## Files in This Module

| File | Purpose |
|------|---------|
| `1.3.10.a_fileGithubRepoRunnerHandshakeExecutor.ts` | Core GitHub executor |
| `1.3.10.b_fileGithubRepoRunnerCredentialFormFields.tsx` | React configuration UI |
| `1.3.10.c_fileGithubRepoRunnerWhitepaperDocumentation.ts` | Technical specification |
| `1.3.10.1.a_fileGithubRepoRunnerProtocolReadme.md` | This documentation |

---

## Related Resources

- [GitHub REST API Docs](https://docs.github.com/en/rest)
- [GitHub GraphQL API Docs](https://docs.github.com/en/graphql)
- [GitHub Actions Docs](https://docs.github.com/en/actions)
- [Creating a GitHub App](https://docs.github.com/en/apps/creating-github-apps)
- [Managing PATs](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-03 | Initial release |

---

*Protocol OS - Configure once, connect anywhere.*
