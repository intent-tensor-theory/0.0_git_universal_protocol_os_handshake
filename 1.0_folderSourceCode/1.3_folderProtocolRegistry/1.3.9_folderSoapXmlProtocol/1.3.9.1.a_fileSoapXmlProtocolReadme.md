# SOAP/XML Protocol

> **Address:** 1.3.9  
> **Type:** Protocol Module  
> **Status:** ✅ Production Ready  
> **Version:** 1.0.0

---

## Overview

SOAP (Simple Object Access Protocol) is an XML-based messaging protocol for exchanging structured information in enterprise web services. It provides platform-independent communication with strong typing, built-in error handling, and enterprise-grade security.

```
┌──────────────────┐                    ┌──────────────────┐
│     Client       │                    │   SOAP Service   │
└────────┬─────────┘                    └────────┬─────────┘
         │                                       │
         │  POST /soap/service                   │
         │  Content-Type: text/xml               │
         │  SOAPAction: "..."                    │
         │  <soap:Envelope>                      │
         │    <soap:Header>Security</soap:Header>│
         │    <soap:Body>Request</soap:Body>    │
         │  </soap:Envelope>                     │
         │──────────────────────────────────────▶│
         │                                       │
         │  <soap:Envelope>                      │
         │    <soap:Body>Response</soap:Body>   │
         │  </soap:Envelope>                     │
         │◀──────────────────────────────────────│
         │                                       │
         ▼                                       ▼
```

---

## Key Features

| Feature | Description |
|---------|-------------|
| XML Format | Structured, strongly-typed messages |
| WSDL | Machine-readable service contracts |
| WS-Security | Enterprise authentication & encryption |
| SOAP Faults | Standardized error handling |
| Transport Agnostic | HTTP, SMTP, JMS, etc. |

---

## When to Use This Module

| Use Case | Recommended? |
|----------|--------------|
| Enterprise integration (ERP, CRM) | ✅ Yes |
| Banking & financial services | ✅ Yes |
| Healthcare systems | ✅ Yes |
| Government services | ✅ Yes |
| B2B with contracts | ✅ Yes |
| Legacy system integration | ✅ Yes |
| Public web/mobile APIs | ❌ Use REST |
| Simple CRUD operations | ❌ Use REST |

---

## Quick Start

### 1. Configure Service

```typescript
const credentials = {
  endpoint: 'https://api.example.com/soap/service',
  wsdlUrl: 'https://api.example.com/soap/service?wsdl',
  soapVersion: '1.1',
  authMethod: 'ws-security-username',
  username: process.env.SOAP_USERNAME,
  password: process.env.SOAP_PASSWORD,
  passwordType: 'PasswordText',
  includeTimestamp: true,
};
```

### 2. Create Executor

```typescript
import { SoapXmlHandshakeExecutor } from './1.3.9.a_fileSoapXmlHandshakeExecutor';

const executor = new SoapXmlHandshakeExecutor();

// Authenticate
const authResult = await executor.authenticate(credentials);
if (authResult.type === 'complete') {
  console.log('SOAP service configured');
}
```

### 3. Execute Request

```typescript
const result = await executor.executeRequest({
  credentials,
  url: credentials.endpoint,
  method: 'POST',
  headers: {},
  body: `
    <GetStockPrice xmlns="http://example.com/stock">
      <Symbol>MSFT</Symbol>
    </GetStockPrice>
  `,
});

if (result.success) {
  console.log('Response:', result.body);
} else {
  console.error('Error:', result.error);
}
```

---

## Authentication Methods

### 1. WS-Security UsernameToken

```typescript
const credentials = {
  endpoint: 'https://api.example.com/soap',
  soapVersion: '1.1',
  authMethod: 'ws-security-username',
  username: 'myuser',
  password: 'mypassword',
  passwordType: 'PasswordText', // or 'PasswordDigest'
  includeTimestamp: true,
  timestampTtl: 300,
};
```

Generated SOAP Header:
```xml
<wsse:Security soap:mustUnderstand="1">
  <wsu:Timestamp>
    <wsu:Created>2024-01-15T10:30:00Z</wsu:Created>
    <wsu:Expires>2024-01-15T10:35:00Z</wsu:Expires>
  </wsu:Timestamp>
  <wsse:UsernameToken>
    <wsse:Username>myuser</wsse:Username>
    <wsse:Password Type="...#PasswordText">mypassword</wsse:Password>
    <wsse:Nonce>...</wsse:Nonce>
    <wsu:Created>2024-01-15T10:30:00Z</wsu:Created>
  </wsse:UsernameToken>
</wsse:Security>
```

### 2. HTTP Basic Authentication

```typescript
const credentials = {
  endpoint: 'https://api.example.com/soap',
  soapVersion: '1.1',
  authMethod: 'basic-auth',
  username: 'myuser',
  password: 'mypassword',
};
// HTTP Header: Authorization: Basic dXNlcjpwYXNz
```

### 3. HTTP Bearer Token

```typescript
const credentials = {
  endpoint: 'https://api.example.com/soap',
  soapVersion: '1.1',
  authMethod: 'bearer-token',
  bearerToken: 'eyJhbGciOiJIUzI1NiIs...',
};
// HTTP Header: Authorization: Bearer eyJ...
```

### 4. Custom SOAP Header

```typescript
const credentials = {
  endpoint: 'https://api.example.com/soap',
  soapVersion: '1.1',
  authMethod: 'custom-header',
  customHeader: `
    <auth:SessionId xmlns:auth="http://example.com/auth">
      my-session-id-here
    </auth:SessionId>
  `,
};
```

### 5. No Authentication

```typescript
const credentials = {
  endpoint: 'https://api.example.com/soap',
  soapVersion: '1.1',
  authMethod: 'none',
};
```

---

## Supported Providers

| Provider | Auth Method | Notes |
|----------|-------------|-------|
| UPS Shipping | WS-Security | UsernameToken |
| FedEx Ship | Custom Header | Account credentials |
| Salesforce | Custom Header | SessionHeader |
| SAP Web Services | Basic Auth | HTTP-level |
| Oracle SOA | WS-Security | UsernameToken |
| PayPal SOAP | Custom Header | RequesterCredentials |
| USPS Web Tools | None | URL parameter auth |
| QuickBooks | Custom Header | App ticket |
| Global Weather (Test) | None | Public test service |
| Calculator (Test) | None | Public test service |

---

## SOAP Envelope Builder

Use the builder for complex envelope construction:

```typescript
import { SoapEnvelopeBuilder } from './1.3.9.d_fileSoapXmlEnvelopeBuilder';

const envelope = new SoapEnvelopeBuilder({ version: '1.1' })
  .addNamespace('stock', 'http://example.com/stock')
  .addWsSecurity({
    username: 'user',
    password: 'pass',
    passwordType: 'PasswordText',
    includeTimestamp: true,
    timestampTtl: 300,
    includeNonce: true,
  })
  .buildOperationBody('GetStockPrice', 'http://example.com/stock', {
    Symbol: 'MSFT',
    Exchange: 'NASDAQ',
  })
  .build();
```

---

## Response Parsing

```typescript
import { SoapResponseParser } from './1.3.9.d_fileSoapXmlEnvelopeBuilder';

const parser = new SoapResponseParser(responseXml);

// Check for fault
if (parser.isFault()) {
  const fault = parser.getFault();
  console.error('SOAP Fault:', fault?.faultString);
  console.error('Fault Code:', fault?.faultCode);
} else {
  // Extract body content
  const body = parser.getBody();
  console.log('Response body:', body);
  
  // Extract specific elements
  const price = parser.extractElement(body, 'Price');
  console.log('Stock price:', price);
}
```

---

## Configuration Reference

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `endpoint` | URL | SOAP service endpoint |
| `soapVersion` | Select | SOAP 1.1 or 1.2 |
| `authMethod` | Select | Authentication method |

### Optional Fields

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `wsdlUrl` | URL | - | WSDL location |
| `username` | Text | - | For WS-Security/Basic |
| `password` | Secret | - | For WS-Security/Basic |
| `passwordType` | Select | PasswordText | WS-Security password encoding |
| `bearerToken` | Secret | - | For bearer auth |
| `customHeader` | Textarea | - | Custom SOAP header XML |
| `soapAction` | Text | - | SOAPAction header |
| `targetNamespace` | Text | - | Service namespace |
| `includeTimestamp` | Boolean | true | Add WS-Security timestamp |
| `timestampTtl` | Number | 300 | Timestamp validity (seconds) |
| `timeout` | Number | 30000 | Request timeout (ms) |

---

## SOAP Versions

### SOAP 1.1

```http
POST /soap/service HTTP/1.1
Content-Type: text/xml; charset=utf-8
SOAPAction: "http://example.com/Action"
```

```xml
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>...</soap:Body>
</soap:Envelope>
```

### SOAP 1.2

```http
POST /soap/service HTTP/1.1
Content-Type: application/soap+xml; charset=utf-8; action="http://example.com/Action"
```

```xml
<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
  <soap:Body>...</soap:Body>
</soap:Envelope>
```

---

## SOAP Faults

### Fault Structure

```xml
<soap:Fault>
  <faultcode>soap:Client</faultcode>
  <faultstring>Invalid input parameter</faultstring>
  <faultactor>http://example.com/service</faultactor>
  <detail>
    <error>Field 'quantity' must be positive</error>
  </detail>
</soap:Fault>
```

### Common Fault Codes

| Code | SOAP 1.1 | SOAP 1.2 | Meaning |
|------|----------|----------|---------|
| Client Error | `Client` | `Sender` | Bad request |
| Server Error | `Server` | `Receiver` | Processing error |
| Version | `VersionMismatch` | `VersionMismatch` | Wrong SOAP version |
| Header | `MustUnderstand` | `MustUnderstand` | Required header not processed |

---

## Error Handling

```typescript
const result = await executor.executeRequest(context);

if (result.success) {
  // Success - process response
  const response = result.body;
} else {
  // Check for SOAP Fault
  const fault = (result.body as any)?.fault;
  if (fault) {
    console.error('SOAP Fault Code:', fault.faultCode);
    console.error('SOAP Fault String:', fault.faultString);
    if (fault.detail) {
      console.error('Detail:', fault.detail);
    }
  } else {
    // HTTP or network error
    console.error('Error:', result.error);
    console.error('Error Code:', result.errorCode);
  }
}
```

---

## WSDL Integration

### Fetch WSDL

```typescript
const credentials = {
  endpoint: 'https://api.example.com/soap/service',
  wsdlUrl: 'https://api.example.com/soap/service?wsdl',
  // ...
};

// Health check fetches and validates WSDL
const health = await executor.healthCheck(credentials);
if (health.healthy) {
  console.log('WSDL valid, service reachable');
}
```

---

## Best Practices

### Security

- ✅ Always use HTTPS in production
- ✅ Use WS-Security for sensitive operations
- ✅ Prefer Password Digest over Plain Text
- ✅ Include timestamp to prevent replay attacks
- ✅ Validate incoming SOAP headers

### Message Design

- ✅ Use document/literal style
- ✅ Define clear namespaces
- ✅ Use meaningful operation names
- ✅ Keep messages reasonably sized

### Error Handling

- ✅ Check for SOAP Faults in responses
- ✅ Handle network errors separately
- ✅ Log errors for debugging
- ✅ Implement retry for transient errors

---

## Troubleshooting

### "MustUnderstand" Fault

Server received a header marked `mustUnderstand="1"` that it doesn't know how to process.

**Solution**: Remove or modify the header, or ensure server supports it.

### "VersionMismatch" Fault

SOAP version mismatch between client and server.

**Solution**: Check `soapVersion` matches server requirements (1.1 vs 1.2).

### Authentication Failures

1. Verify username/password are correct
2. Check password type matches server expectation
3. Ensure timestamp is within TTL
4. Verify custom headers match service requirements

### Connection Timeout

1. Increase `timeout` configuration
2. Check network connectivity
3. Verify endpoint URL is correct
4. Check firewall/proxy settings

---

## Files in This Module

| File | Purpose |
|------|---------|
| `1.3.9.a_fileSoapXmlHandshakeExecutor.ts` | Core SOAP executor |
| `1.3.9.b_fileSoapXmlCredentialFormFields.tsx` | React configuration UI |
| `1.3.9.c_fileSoapXmlWhitepaperDocumentation.ts` | Technical specification |
| `1.3.9.d_fileSoapXmlEnvelopeBuilder.ts` | Envelope builder utilities |
| `1.3.9.1.a_fileSoapXmlProtocolReadme.md` | This documentation |

---

## Related Resources

- [SOAP 1.1 Specification](https://www.w3.org/TR/2000/NOTE-SOAP-20000508/)
- [SOAP 1.2 Specification](https://www.w3.org/TR/soap12/)
- [WS-Security 1.1](https://docs.oasis-open.org/wss/v1.1/)
- [WSDL 1.1](https://www.w3.org/TR/wsdl)
- [SoapUI Testing Tool](https://www.soapui.org/)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-03 | Initial release |

---

*Protocol OS - Configure once, connect anywhere.*
