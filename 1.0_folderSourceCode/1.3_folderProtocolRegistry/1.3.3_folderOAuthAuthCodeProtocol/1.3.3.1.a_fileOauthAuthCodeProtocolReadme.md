# OAuth 2.0 Authorization Code Protocol

> **Address:** 1.3.3  
> **Type:** Protocol Module  
> **Status:** Stable  
> **Version:** 1.0.0  
> **RFC:** RFC 6749 - The OAuth 2.0 Authorization Framework

Traditional OAuth 2.0 Authorization Code flow for **confidential clients** (server-side applications) that can securely store a `client_secret`.

---

## Overview

This module implements the standard OAuth 2.0 Authorization Code Grant for applications that run on secure servers where the `client_secret` can be protected. This is the most secure OAuth flow and is recommended for all server-side integrations.

### When to Use This Module

| Use Case | Recommended |
|----------|-------------|
| Server-side web apps (Node.js, Python, Java, .NET) | ✅ Yes |
| Backend API integrations | ✅ Yes |
| Enterprise SaaS integrations (Salesforce, HubSpot) | ✅ Yes |
| Single-page applications (React, Vue) | ❌ Use PKCE (1.3.2) |
| Mobile apps (iOS, Android) | ❌ Use PKCE (1.3.2) |
| Desktop apps | ❌ Use PKCE (1.3.2) |

---

## Quick Start

### 1. Configure OAuth Application

```typescript
const credentials = {
  clientId: 'your-client-id',
  clientSecret: 'your-client-secret',  // ⚠️ Keep secure!
  authorizationUrl: 'https://login.salesforce.com/services/oauth2/authorize',
  tokenUrl: 'https://login.salesforce.com/services/oauth2/token',
  redirectUri: 'https://yourapp.com/oauth/callback',
  scopes: 'api refresh_token',
  clientAuthMethod: 'client_secret_basic',
};
```

### 2. Start Authorization Flow

```typescript
import { OAuthAuthCodeHandshakeExecutor } from './1.3.3.a_fileOauthAuthCodeHandshakeExecutor';

const executor = new OAuthAuthCodeHandshakeExecutor();
const authFlow = await executor.authenticate(credentials);

if (authFlow.type === 'redirect') {
  // Redirect user to OAuth provider
  res.redirect(authFlow.redirectUrl);
}
```

### 3. Handle Callback (Server-Side)

```typescript
// In your callback route (/oauth/callback)
app.get('/oauth/callback', async (req, res) => {
  const { code, state } = req.query;
  
  // Validate state parameter
  if (state !== session.oauthState) {
    return res.status(400).send('Invalid state');
  }
  
  // Exchange code for tokens (server-side with client_secret)
  const tokens = await executor.performTokenExchange(credentials, code);
  
  // Store tokens securely
  await saveTokens(session.userId, tokens);
  
  res.redirect('/dashboard');
});
```

### 4. Make Authenticated Requests

```typescript
const result = await executor.executeRequest({
  credentials: {
    ...credentials,
    accessToken: tokens.access_token,
    refreshToken: tokens.refresh_token,
  },
  url: 'https://yourinstance.salesforce.com/services/data/v58.0/sobjects/Account',
  method: 'GET',
  headers: {},
});
```

---

## Flow Diagram

```
┌──────────┐           ┌──────────┐           ┌──────────┐
│  Browser │           │  Server  │           │  OAuth   │
│          │           │ (Backend)│           │ Provider │
└────┬─────┘           └────┬─────┘           └────┬─────┘
     │                      │                      │
     │ 1. Click Login       │                      │
     │─────────────────────▶│                      │
     │                      │                      │
     │ 2. Redirect to OAuth │                      │
     │◀─────────────────────│                      │
     │                      │                      │
     │ 3. Authenticate & Authorize                 │
     │────────────────────────────────────────────▶│
     │                      │                      │
     │ 4. Redirect with code                       │
     │◀────────────────────────────────────────────│
     │                      │                      │
     │ 5. Send code to server                      │
     │─────────────────────▶│                      │
     │                      │                      │
     │                      │ 6. Exchange code +   │
     │                      │    client_secret     │
     │                      │    for tokens        │
     │                      │─────────────────────▶│
     │                      │                      │
     │                      │ 7. Tokens returned   │
     │                      │◀─────────────────────│
     │                      │                      │
     │ 8. Success           │                      │
     │◀─────────────────────│                      │
     │                      │                      │
```

---

## Supported Providers

| Provider | Auth URL | Notes |
|----------|----------|-------|
| **Salesforce** | login.salesforce.com | Uses instance_url from response |
| **HubSpot** | app.hubspot.com | Uses client_secret_post |
| **QuickBooks** | appcenter.intuit.com | Returns realmId (company ID) |
| **Xero** | login.xero.com | Multi-tenant support |
| **DocuSign** | account.docusign.com | eSignature API |
| **Box** | account.box.com | No traditional scopes |
| **Stripe Connect** | connect.stripe.com | For platform integrations |
| **Mailchimp** | login.mailchimp.com | Datacenter-specific URLs |

---

## Client Authentication Methods

Choose based on your OAuth provider's requirements:

### 1. client_secret_basic (Default)

Credentials in Authorization header:

```http
POST /token HTTP/1.1
Authorization: Basic {base64(client_id:client_secret)}
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&code=xxx&redirect_uri=xxx
```

### 2. client_secret_post

Credentials in POST body:

```http
POST /token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&code=xxx
&redirect_uri=xxx
&client_id=xxx
&client_secret=xxx
```

### 3. client_secret_jwt

Client assertion JWT:

```http
POST /token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&code=xxx
&client_id=xxx
&client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer
&client_assertion={signed_jwt}
```

---

## Configuration Reference

### Required Fields

| Field | Description | Example |
|-------|-------------|---------|
| `clientId` | OAuth client ID | `3MVG9...` |
| `clientSecret` | OAuth client secret | `abc123...` |
| `authorizationUrl` | Provider's authorize endpoint | `https://auth.example.com/authorize` |
| `tokenUrl` | Provider's token endpoint | `https://auth.example.com/token` |
| `redirectUri` | Your callback URL | `https://yourapp.com/callback` |
| `scopes` | Requested permissions | `api refresh_token` |

### Optional Fields

| Field | Description | Default |
|-------|-------------|---------|
| `clientAuthMethod` | Authentication method | `client_secret_basic` |
| `userInfoUrl` | User info endpoint | - |
| `revocationUrl` | Token revocation endpoint | - |
| `introspectionUrl` | Token introspection endpoint | - |
| `audience` | API audience | - |

---

## Security Best Practices

### ⚠️ Client Secret Protection

```typescript
// ✅ GOOD: Load from environment
const clientSecret = process.env.OAUTH_CLIENT_SECRET;

// ✅ GOOD: Use secrets manager
const clientSecret = await secretsManager.getSecret('oauth-client-secret');

// ❌ BAD: Hardcoded
const clientSecret = 'abc123xyz';

// ❌ BAD: In client-side code
const clientSecret = window.OAUTH_SECRET; // NEVER!
```

### State Parameter (CSRF Protection)

```typescript
// Before redirect
const state = crypto.randomBytes(32).toString('hex');
session.oauthState = state;

// On callback
if (req.query.state !== session.oauthState) {
  throw new Error('CSRF attack detected');
}
delete session.oauthState;
```

### Secure Token Storage

```typescript
// ✅ GOOD: Encrypted database
const encryptedToken = encrypt(accessToken, encryptionKey);
await db.tokens.update({ userId }, { 
  accessToken: encryptedToken,
  tokenIv: iv 
});

// ✅ GOOD: Secrets manager for service accounts
await vault.write('secret/oauth/token', { accessToken });

// ❌ BAD: Plain text storage
await db.tokens.update({ userId }, { accessToken });
```

---

## Token Management

### Refresh Tokens

```typescript
// Proactive refresh (before expiration)
if (tokenExpiresIn < 300) { // Less than 5 minutes
  const refreshResult = await executor.refreshTokens(credentials);
  if (refreshResult.success) {
    credentials.accessToken = refreshResult.accessToken;
    if (refreshResult.refreshToken) {
      credentials.refreshToken = refreshResult.refreshToken; // May be rotated
    }
  }
}
```

### Token Introspection

```typescript
// Validate token without making API call
const introspection = await executor.introspectToken(credentials);
if (!introspection.active) {
  // Token is invalid or expired
}
```

### Token Revocation

```typescript
// On logout or disconnect
await executor.revokeTokens(credentials);
```

---

## Error Handling

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| `invalid_client` | Wrong client_id or client_secret | Verify credentials |
| `invalid_grant` | Code expired or already used | Restart auth flow |
| `invalid_scope` | Unsupported scope | Check provider docs |
| `access_denied` | User denied consent | Handle gracefully |
| `unauthorized_client` | Grant type not allowed | Check app settings |

### Example Error Handling

```typescript
try {
  const tokens = await executor.performTokenExchange(credentials, code);
} catch (error) {
  if (error.message.includes('invalid_grant')) {
    // Code expired - restart flow
    return res.redirect('/auth/start');
  }
  if (error.message.includes('invalid_client')) {
    // Configuration issue
    console.error('OAuth configuration error');
  }
  throw error;
}
```

---

## Provider-Specific Notes

### Salesforce

```typescript
// Use instance_url from token response for API calls
const tokenResponse = await executor.performTokenExchange(credentials, code);
const apiBaseUrl = tokenResponse.instance_url; // e.g., https://na1.salesforce.com

// API requests
const accounts = await fetch(`${apiBaseUrl}/services/data/v58.0/sobjects/Account`);
```

### HubSpot

```typescript
// HubSpot requires client_secret_post
const credentials = {
  ...baseCredentials,
  clientAuthMethod: 'client_secret_post',
};
```

### QuickBooks

```typescript
// Store realmId for API calls
const tokenResponse = await executor.performTokenExchange(credentials, code);
const realmId = tokenResponse.realmId;

// API requests require realmId
const accounts = await fetch(
  `https://quickbooks.api.intuit.com/v3/company/${realmId}/query`
);
```

---

## Comparison with PKCE

| Feature | Auth Code (This Module) | PKCE (1.3.2) |
|---------|------------------------|--------------|
| Client Secret | Required | Not used |
| Token Exchange | Server-side | Client-side OK |
| Security | client_secret | code_verifier |
| Use Case | Server apps | SPAs, mobile |
| Complexity | Simpler | Slightly more complex |

---

## Troubleshooting

### "invalid_client" Error

- Verify `client_id` is correct
- Verify `client_secret` is correct
- Check `client_auth_method` matches provider requirements
- Ensure credentials aren't URL-encoded twice

### "invalid_grant" Error

- Authorization code may have expired (usually 1-10 minutes)
- Code may have already been exchanged (single-use)
- `redirect_uri` must exactly match registered URI

### No Refresh Token Returned

- Some providers require specific scopes (e.g., `offline_access`, `refresh_token`)
- Some providers only return refresh token on first authorization
- Check provider documentation for refresh token requirements

### Token Refresh Fails

- Refresh token may have expired
- Refresh token may have been revoked
- Client credentials may have changed
- If using rotation, ensure you're using the latest refresh token

---

## Files in This Module

| File | Purpose |
|------|---------|
| `1.3.3.a_fileOauthAuthCodeHandshakeExecutor.ts` | Core OAuth implementation |
| `1.3.3.b_fileOauthAuthCodeCredentialFormFields.tsx` | React UI component |
| `1.3.3.c_fileOauthAuthCodeWhitepaperDocumentation.ts` | Technical specification |
| `1.3.3.1.a_fileOauthAuthCodeProtocolReadme.md` | This documentation |

---

## Related Resources

- [RFC 6749 - OAuth 2.0](https://datatracker.ietf.org/doc/html/rfc6749)
- [OAuth PKCE Module (1.3.2)](../1.3.2_folderOAuthPkceProtocol/) - For public clients
- [Protocol Module Interface](../1.3.b_fileProtocolHandshakeModuleInterface.ts)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-03 | Initial release |

---

*Protocol OS - Configure once, connect anywhere.*
