# OAuth 2.0 Client Credentials Protocol

> **Address:** 1.3.5  
> **Type:** Protocol Module  
> **Status:** âœ… Production Ready  
> **Version:** 1.0.0  
> **RFC:** RFC 6749 Section 4.4

---

## Overview

The **Client Credentials Grant** is designed for **machine-to-machine (M2M)** authentication where no human user is involved. Your backend service authenticates directly with its own credentials to obtain an access token.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Your Service   â”‚                    â”‚   OAuth Server   â”‚
â”‚   (Backend)      â”‚                    â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                       â”‚
         â”‚  POST: client_id + client_secret      â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
         â”‚                                       â”‚
         â”‚  { "access_token": "..." }            â”‚
         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                                       â”‚
         â”‚  Use token for API calls              â”‚
         â–¼                                       â–¼
```

---

## When to Use This Module

| Use Case | Recommended? |
|----------|--------------|
| Backend service-to-service API calls | âœ… Yes |
| Microservices authentication | âœ… Yes |
| Scheduled jobs / Cron tasks | âœ… Yes |
| CLI tools and automation scripts | âœ… Yes |
| Server-side API integrations | âœ… Yes |
| Daemon processes | âœ… Yes |
| Browser/SPA applications | âŒ No (use PKCE) |
| Mobile applications | âŒ No (use PKCE) |
| Apps where users log in | âŒ No (use Auth Code) |

---

## Quick Start

### 1. Configure Credentials

```typescript
const credentials = {
  tokenUrl: 'https://auth.provider.com/oauth/token',
  clientId: 'your-service-client-id',
  clientSecret: process.env.OAUTH_CLIENT_SECRET, // From env!
  scopes: 'read:data write:data',
  audience: 'https://api.example.com', // Required by some providers
  clientAuthMethod: 'client_secret_basic',
};
```

### 2. Get Access Token

```typescript
import { ClientCredentialsHandshakeExecutor } from './1.3.5.a_fileClientCredentialsHandshakeExecutor';

const executor = new ClientCredentialsHandshakeExecutor();
const authResult = await executor.authenticate(credentials);

if (authResult.type === 'complete') {
  const { accessToken, expiresIn } = authResult.data;
  console.log('Token obtained, expires in', expiresIn, 'seconds');
}
```

### 3. Make Authenticated API Requests

```typescript
const result = await executor.executeRequest({
  credentials: {
    ...credentials,
    accessToken: authResult.data.accessToken,
    tokenExpiresAt: authResult.data.expiresAt,
  },
  url: 'https://api.example.com/v1/data',
  method: 'GET',
  headers: { 'Content-Type': 'application/json' },
});

if (result.success) {
  console.log('API Response:', result.body);
}
```

### 4. Token Auto-Refresh

The executor automatically handles token expiration:

```typescript
// Token refresh is handled automatically in executeRequest()
// If token is expired, a new one is requested before the API call

const result = await executor.executeRequest({
  credentials,
  url: 'https://api.example.com/v1/data',
  method: 'GET',
  headers: {},
});

// Check if credentials were refreshed
if (result.credentialsRefreshed) {
  // Update your stored credentials
  credentials.accessToken = result.updatedCredentials.accessToken;
  credentials.tokenExpiresAt = result.updatedCredentials.tokenExpiresAt;
}
```

---

## Supported Providers

| Provider | Token URL | Auth Method | Notes |
|----------|-----------|-------------|-------|
| Auth0 | `https://{domain}/oauth/token` | POST body | Requires `audience` |
| Okta | `https://{domain}/oauth2/default/v1/token` | Basic | Standard |
| Azure AD | `https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token` | POST body | Use `.default` scope |
| Google | `https://oauth2.googleapis.com/token` | JWT (RS256) | Service accounts |
| AWS Cognito | `https://{domain}.auth.{region}.amazoncognito.com/oauth2/token` | Basic | Resource server scopes |
| Salesforce | `https://login.salesforce.com/services/oauth2/token` | POST body | Server-to-server |

---

## Client Authentication Methods

### 1. Basic Auth Header (Recommended)

```
Authorization: Basic base64(client_id:client_secret)
```

```typescript
const credentials = {
  ...baseCredentials,
  clientAuthMethod: 'client_secret_basic',
};
```

### 2. POST Body

```
client_id=xxx&client_secret=yyy in POST body
```

```typescript
const credentials = {
  ...baseCredentials,
  clientAuthMethod: 'client_secret_post',
};
```

### 3. JWT Assertion (HS256)

JWT signed with client_secret:

```typescript
const credentials = {
  ...baseCredentials,
  clientAuthMethod: 'client_secret_jwt',
};
```

### 4. Private Key JWT (RS256)

JWT signed with private key (e.g., Google Service Accounts):

```typescript
const credentials = {
  ...baseCredentials,
  clientAuthMethod: 'private_key_jwt',
  privateKey: '-----BEGIN PRIVATE KEY-----\n...',
  keyId: 'your-key-id', // Optional
};
```

---

## Configuration Reference

### Required Fields

| Field | Description | Example |
|-------|-------------|---------|
| `tokenUrl` | OAuth token endpoint | `https://auth.provider.com/oauth/token` |
| `clientId` | Service client ID | `my-backend-service` |
| `clientSecret` | Service client secret | (from env var) |

### Optional Fields

| Field | Description | Default |
|-------|-------------|---------|
| `scopes` | Space-separated scopes | Provider default |
| `clientAuthMethod` | Authentication method | `client_secret_basic` |
| `audience` | Target API identifier | - |
| `resource` | RFC 8707 resource indicator | - |
| `introspectionUrl` | Token validation endpoint | - |
| `revocationUrl` | Token revocation endpoint | - |

---

## Security Best Practices

### ğŸ” Credential Protection

```typescript
// âœ… GOOD: Load from environment
const clientSecret = process.env.OAUTH_CLIENT_SECRET;

// âœ… GOOD: Use secrets manager
const clientSecret = await secretsManager.getSecret('oauth-client-secret');

// âŒ BAD: Hardcoded
const clientSecret = 'super-secret-123';

// âŒ BAD: In version control
// .env file committed to git
```

### ğŸ”„ Token Lifecycle

```typescript
class TokenManager {
  private token: string | null = null;
  private expiresAt: number = 0;
  private executor: ClientCredentialsHandshakeExecutor;
  
  async getToken(): Promise<string> {
    // Proactive refresh (5 min before expiration)
    const bufferMs = 5 * 60 * 1000;
    
    if (!this.token || Date.now() > this.expiresAt - bufferMs) {
      const result = await this.executor.authenticate(this.credentials);
      if (result.type === 'complete') {
        this.token = result.data.accessToken;
        this.expiresAt = result.data.expiresAt * 1000;
      }
    }
    
    return this.token!;
  }
}
```

### ğŸ“Š Scope Minimization

```typescript
// âœ… GOOD: Minimal scopes
const scopes = 'read:users';

// âŒ BAD: Over-privileged
const scopes = 'read:users write:users delete:users admin:all';
```

---

## Error Handling

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| `invalid_client` | Wrong credentials | Verify client_id and client_secret |
| `invalid_grant` | Grant type not allowed | Enable client credentials in provider |
| `invalid_scope` | Scope not allowed | Check allowed scopes for client |
| `unauthorized_client` | Client not authorized | Configure client permissions |

### Example Error Handling

```typescript
try {
  const result = await executor.authenticate(credentials);
  
  if (result.type === 'error') {
    switch (true) {
      case result.error?.includes('invalid_client'):
        console.error('Check your client_id and client_secret');
        break;
      case result.error?.includes('invalid_scope'):
        console.error('Requested scope not allowed');
        break;
      default:
        console.error('Authentication failed:', result.error);
    }
  }
} catch (error) {
  console.error('Network or unexpected error:', error);
}
```

---

## Token Introspection

Validate a token without making an API call:

```typescript
const introspection = await executor.introspectToken(
  credentials,
  accessToken
);

if (introspection.active) {
  console.log('Token is valid');
  console.log('Scopes:', introspection.scope);
  console.log('Expires:', new Date(introspection.exp * 1000));
} else {
  console.log('Token is invalid or expired');
}
```

---

## Token Revocation

Revoke a token (e.g., during shutdown or rotation):

```typescript
const result = await executor.revokeTokens(credentials);

if (result.success) {
  console.log('Token revoked successfully');
}
```

---

## Provider-Specific Examples

### Auth0

```typescript
const credentials = {
  tokenUrl: 'https://your-tenant.auth0.com/oauth/token',
  clientId: 'YOUR_CLIENT_ID',
  clientSecret: process.env.AUTH0_CLIENT_SECRET,
  audience: 'https://api.example.com', // REQUIRED!
  clientAuthMethod: 'client_secret_post',
};
```

### Azure AD

```typescript
const credentials = {
  tokenUrl: 'https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token',
  clientId: 'YOUR_CLIENT_ID',
  clientSecret: process.env.AZURE_CLIENT_SECRET,
  scopes: 'https://graph.microsoft.com/.default',
  clientAuthMethod: 'client_secret_post',
};
```

### Google Service Account

```typescript
const credentials = {
  tokenUrl: 'https://oauth2.googleapis.com/token',
  clientId: 'service-account@project.iam.gserviceaccount.com',
  scopes: 'https://www.googleapis.com/auth/cloud-platform',
  clientAuthMethod: 'private_key_jwt',
  privateKey: process.env.GOOGLE_PRIVATE_KEY,
};
```

---

## Comparison with Other OAuth Flows

| Feature | Client Credentials | Auth Code | PKCE |
|---------|-------------------|-----------|------|
| User involved | No | Yes | Yes |
| Browser redirect | No | Yes | Yes |
| Refresh tokens | Usually no | Yes | Yes |
| Client secret | Required | Required | Not needed |
| Browser-safe | No | Server-side | Yes |
| Use case | M2M, Backend | Web apps | SPAs, Mobile |

---

## Troubleshooting

### "invalid_client" Error

1. Verify `client_id` is correct
2. Verify `client_secret` is correct
3. Check authentication method matches provider requirements
4. Ensure credentials aren't URL-encoded twice

### "invalid_grant" Error

1. Ensure client credentials grant is enabled for your app
2. Check with provider if this grant type is supported

### "invalid_scope" Error

1. Verify scopes are allowed for your client
2. Check scope format (some providers use URLs, others use short names)
3. Try with no scopes to get defaults

### Token Expires Immediately

1. Check server time is correct (NTP sync)
2. Some providers issue very short-lived tokens - this is normal
3. Implement proactive refresh before expiration

---

## Files in This Module

| File | Purpose |
|------|---------|
| `1.3.5.a_fileClientCredentialsHandshakeExecutor.ts` | Core M2M authentication |
| `1.3.5.b_fileClientCredentialsCredentialFormFields.tsx` | React configuration UI |
| `1.3.5.c_fileClientCredentialsWhitepaperDocumentation.ts` | Technical specification |
| `1.3.5.1.a_fileClientCredentialsProtocolReadme.md` | This documentation |

---

## Related Resources

- [RFC 6749 Section 4.4](https://datatracker.ietf.org/doc/html/rfc6749#section-4.4) - Client Credentials Grant
- [OAuth 2.0 for Server-to-Server](https://oauth.net/2/grant-types/client-credentials/)
- [Auth0 M2M Documentation](https://auth0.com/docs/get-started/authentication-and-authorization-flow/client-credentials-flow)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-03 | Initial release |

---

*Protocol OS - Configure once, connect anywhere.*
