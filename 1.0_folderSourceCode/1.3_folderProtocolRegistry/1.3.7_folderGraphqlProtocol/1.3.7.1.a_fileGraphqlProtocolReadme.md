# GraphQL Protocol

> **Address:** 1.3.7  
> **Type:** Protocol Module  
> **Status:** ✅ Production Ready  
> **Version:** 1.0.0

---

## Overview

GraphQL is a query language for APIs that provides a complete and understandable description of the data in your API. Unlike REST, GraphQL uses a single endpoint and allows clients to request exactly the data they need.

```
┌──────────────────┐                    ┌──────────────────┐
│     Client       │                    │  GraphQL Server  │
└────────┬─────────┘                    └────────┬─────────┘
         │                                       │
         │  POST /graphql                        │
         │  { query: "{ user { name } }" }       │
         │──────────────────────────────────────▶│
         │                                       │
         │  { "data": { "user": { "name": ... }}}│
         │◀──────────────────────────────────────│
         │                                       │
         ▼                                       ▼
```

---

## Key Features

| Feature | Description |
|---------|-------------|
| Single Endpoint | All operations through one URL |
| Strongly Typed | Schema defines available data |
| Client-Specified | Request only fields you need |
| Introspection | Self-documenting API |
| Real-time | Subscriptions for live updates |

---

## When to Use This Module

| Use Case | Recommended? |
|----------|--------------|
| Complex data with relationships | ✅ Yes |
| Mobile apps (bandwidth-sensitive) | ✅ Yes |
| Rapidly evolving APIs | ✅ Yes |
| Multiple client types | ✅ Yes |
| Real-time features | ✅ Yes |
| Simple CRUD operations | ⚠️ Consider REST |
| File uploads | ⚠️ Consider REST |

---

## Quick Start

### 1. Configure Endpoint

```typescript
const credentials = {
  endpoint: 'https://api.example.com/graphql',
  authMethod: 'bearer',
  authToken: process.env.GRAPHQL_TOKEN,
};
```

### 2. Create Executor

```typescript
import { GraphQLHandshakeExecutor } from './1.3.7.a_fileGraphqlHandshakeExecutor';

const executor = new GraphQLHandshakeExecutor();

// Test connection
const authResult = await executor.authenticate(credentials);
if (authResult.type === 'complete') {
  console.log('Connected to GraphQL endpoint');
}
```

### 3. Execute Queries

```typescript
// Simple query
const result = await executor.query(
  credentials,
  `query {
    user(id: "123") {
      name
      email
    }
  }`
);

if (result.data) {
  console.log('User:', result.data.user);
}

if (result.errors) {
  console.error('Errors:', result.errors);
}
```

### 4. Execute Mutations

```typescript
const result = await executor.mutate(
  credentials,
  `mutation CreateUser($input: CreateUserInput!) {
    createUser(input: $input) {
      id
      name
    }
  }`,
  { input: { name: 'John', email: 'john@example.com' } }
);
```

---

## Authentication Methods

### 1. Bearer Token (Most Common)

```typescript
const credentials = {
  endpoint: 'https://api.github.com/graphql',
  authMethod: 'bearer',
  authToken: 'ghp_xxxxxxxxxxxx',
};
// Result: Authorization: Bearer ghp_xxxxxxxxxxxx
```

### 2. API Key Header

```typescript
const credentials = {
  endpoint: 'https://api.example.com/graphql',
  authMethod: 'api-key',
  authToken: 'your-api-key',
  authHeaderName: 'X-API-Key',
};
// Result: X-API-Key: your-api-key
```

### 3. Custom Header

```typescript
const credentials = {
  endpoint: 'https://shop.myshopify.com/api/graphql.json',
  authMethod: 'custom-header',
  authToken: 'storefront-token',
  authHeaderName: 'X-Shopify-Storefront-Access-Token',
};
// Result: X-Shopify-Storefront-Access-Token: storefront-token
```

### 4. No Authentication (Public APIs)

```typescript
const credentials = {
  endpoint: 'https://countries.trevorblades.com/graphql',
  authMethod: 'none',
};
```

---

## Supported Providers

| Provider | Endpoint Pattern | Auth Method | Notes |
|----------|-----------------|-------------|-------|
| GitHub | api.github.com/graphql | Bearer | PAT required |
| Shopify | {store}.myshopify.com/api/.../graphql.json | Custom Header | Storefront token |
| Contentful | graphql.contentful.com/content/v1/spaces/{id} | Bearer | CDA token |
| Hasura | {project}.hasura.app/v1/graphql | Custom Header | Admin secret |
| Hygraph | {region}.hygraph.com/v2/{id}/master | Bearer | API token |
| Strapi | localhost:1337/graphql | Bearer | Optional |
| Fauna | graphql.fauna.com/graphql | Bearer | Secret key |
| Countries API | countries.trevorblades.com/graphql | None | Public |
| SpaceX API | spacex-production.up.railway.app | None | Public |

---

## GraphQL Operations

### Queries (Read Data)

```graphql
# Simple query
query {
  user(id: "123") {
    name
    email
  }
}

# Named query with variables
query GetUser($userId: ID!) {
  user(id: $userId) {
    id
    name
    posts(first: 5) {
      title
      createdAt
    }
  }
}
```

### Mutations (Write Data)

```graphql
mutation CreatePost($input: CreatePostInput!) {
  createPost(input: $input) {
    id
    title
    author {
      name
    }
  }
}
```

### Introspection (Schema Discovery)

```graphql
query {
  __schema {
    types {
      name
      kind
    }
    queryType { name }
    mutationType { name }
  }
}
```

---

## Response Format

### Successful Response

```json
{
  "data": {
    "user": {
      "id": "123",
      "name": "John Doe"
    }
  }
}
```

### Error Response

```json
{
  "data": null,
  "errors": [
    {
      "message": "User not found",
      "locations": [{ "line": 2, "column": 3 }],
      "path": ["user"],
      "extensions": {
        "code": "NOT_FOUND"
      }
    }
  ]
}
```

### Partial Success

```json
{
  "data": {
    "user": { "name": "John" },
    "posts": null
  },
  "errors": [
    {
      "message": "Not authorized",
      "path": ["posts"]
    }
  ]
}
```

---

## Error Handling

### Common Error Codes

| Code | Meaning | Solution |
|------|---------|----------|
| `GRAPHQL_PARSE_FAILED` | Syntax error | Check query syntax |
| `GRAPHQL_VALIDATION_FAILED` | Schema mismatch | Check field names |
| `UNAUTHENTICATED` | Not logged in | Check token |
| `FORBIDDEN` | Not authorized | Check permissions |
| `NOT_FOUND` | Resource missing | Check IDs |

### Example Error Handling

```typescript
const result = await executor.query(credentials, query);

if (result.errors) {
  for (const error of result.errors) {
    const code = error.extensions?.code;
    
    switch (code) {
      case 'UNAUTHENTICATED':
        // Refresh token or re-login
        break;
      case 'NOT_FOUND':
        // Handle missing resource
        break;
      default:
        console.error(error.message);
    }
  }
}

// Note: data may still be present (partial success)
if (result.data) {
  // Process successful parts
}
```

---

## Schema Introspection

Discover the API schema programmatically:

```typescript
const introspection = await executor.introspect(credentials);

if (introspection.success) {
  console.log('Schema:', introspection.schema);
  
  // Get available types
  const types = introspection.schema.__schema.types;
  console.log('Types:', types.map(t => t.name));
}
```

⚠️ **Note:** Many production APIs disable introspection for security.

---

## Health Check

Test connection and credentials:

```typescript
const health = await executor.healthCheck(credentials);

if (health.healthy) {
  console.log('Connected!');
  console.log('Latency:', health.latencyMs, 'ms');
} else {
  console.error('Connection failed:', health.message);
}
```

---

## Configuration Reference

### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `endpoint` | URL | GraphQL API endpoint |
| `authMethod` | Select | Authentication type |

### Optional Fields

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `authToken` | Secret | - | Bearer token or API key |
| `authHeaderName` | Text | `X-API-Key` | Custom header name |
| `authHeaderPrefix` | Text | - | Value prefix |
| `timeout` | Number | 30000 | Request timeout (ms) |
| `enableIntrospection` | Boolean | true | Allow schema queries |
| `subscriptionEndpoint` | URL | - | WebSocket URL |
| `additionalHeaders` | JSON | {} | Extra headers |

---

## Utility Methods

### Parse Operation Type

```typescript
const info = GraphQLHandshakeExecutor.parseOperation(`
  query GetUser { user { name } }
`);
// { type: 'query', name: 'GetUser' }
```

### Format Errors

```typescript
const formatted = GraphQLHandshakeExecutor.formatErrors(result.errors);
// "1. User not found (at user) [line 2, col 3]"
```

### Build Simple Query

```typescript
const query = GraphQLHandshakeExecutor.buildQuery(
  'user',
  ['id', 'name', 'email'],
  { id: '123' }
);
// query { user(id: "123") { id name email } }
```

---

## Provider-Specific Examples

### GitHub

```typescript
const credentials = {
  endpoint: 'https://api.github.com/graphql',
  authMethod: 'bearer',
  authToken: process.env.GITHUB_TOKEN,
};

const result = await executor.query(credentials, `
  query {
    viewer {
      login
      repositories(first: 5) {
        nodes { name stargazerCount }
      }
    }
  }
`);
```

### Shopify Storefront

```typescript
const credentials = {
  endpoint: 'https://mystore.myshopify.com/api/2024-01/graphql.json',
  authMethod: 'custom-header',
  authToken: process.env.SHOPIFY_STOREFRONT_TOKEN,
  authHeaderName: 'X-Shopify-Storefront-Access-Token',
};

const result = await executor.query(credentials, `
  query {
    products(first: 10) {
      edges {
        node {
          title
          handle
          priceRange {
            minVariantPrice { amount currencyCode }
          }
        }
      }
    }
  }
`);
```

### Public API (Countries)

```typescript
const credentials = {
  endpoint: 'https://countries.trevorblades.com/graphql',
  authMethod: 'none',
};

const result = await executor.query(credentials, `
  query {
    countries {
      code
      name
      capital
      currency
    }
  }
`);
```

---

## Best Practices

### Query Design

- ✅ Use named operations: `query GetUser { ... }`
- ✅ Use variables: `query($id: ID!) { user(id: $id) }`
- ✅ Request only needed fields
- ✅ Use fragments for reusable selections
- ❌ Avoid deeply nested queries (> 5 levels)

### Authentication

- ✅ Store tokens in environment variables
- ✅ Implement token refresh
- ✅ Handle 401/403 gracefully
- ❌ Never expose tokens in client-side code

### Error Handling

- ✅ Always check for `errors` in response
- ✅ Handle partial success
- ✅ Use error codes from `extensions`
- ✅ Implement retry for transient errors

---

## Troubleshooting

### "UNAUTHENTICATED" Error

1. Verify token is correct and not expired
2. Check header format matches provider requirements
3. Ensure token has required scopes

### "GRAPHQL_VALIDATION_FAILED"

1. Check field names match schema
2. Verify argument types
3. Use introspection to discover schema

### Connection Timeout

1. Increase `timeout` configuration
2. Check network connectivity
3. Verify endpoint URL is correct

### Introspection Disabled

Many production APIs disable introspection. This is expected behavior, not an error. Use provider documentation for schema reference.

---

## Files in This Module

| File | Purpose |
|------|---------|
| `1.3.7.a_fileGraphqlHandshakeExecutor.ts` | GraphQL execution engine |
| `1.3.7.b_fileGraphqlCredentialFormFields.tsx` | React configuration UI |
| `1.3.7.c_fileGraphqlWhitepaperDocumentation.ts` | Technical specification |
| `1.3.7.1.a_fileGraphqlProtocolReadme.md` | This documentation |

---

## Related Resources

- [GraphQL Specification](https://spec.graphql.org/)
- [GraphQL.org](https://graphql.org/)
- [Apollo GraphQL](https://www.apollographql.com/docs/)
- [GitHub GraphQL Explorer](https://docs.github.com/en/graphql/overview/explorer)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-03 | Initial release |

---

*Protocol OS - Configure once, connect anywhere.*
